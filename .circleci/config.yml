# Ruby CircleCI 2.1 configuration file
#
# Check https://circleci.com/docs/2.0/language-ruby/ for more details
#
version: 2.1

jobs:
  build:
    docker:
      # specify the version you desire here
       - image: jekyll/jekyll:3

    steps:
      - checkout
      - run:
          name: a merge PR
          command: |
            if [[ -n "${CIRCLE_PR_NUMBER}" ]]; then
              git fetch origin +refs/pull/$CIRCLE_PR_NUMBER/merge:pr/$CIRCLE_PR_NUMBER/merge
              git checkout -qf pr/$CIRCLE_PR_NUMBER/merge
            fi

      - run:
          name: Which bundler?
          command: |
            bundle -v
            jekyll -v

      # use the gh-pages orb to build the site as in gh
      - run:
          name: Jekyll build
          command: jekyll build -d html 2> std.err

      - run:
          name: Check Jekyll build
          command: |
            cat std.err
            exit $(wc -l std.err | awk '{print $1}')

      - run:
          name: Jekyll re-build for local
          command: |
            echo "url: https://${CIRCLE_BUILD_NUM}-30926520-gh.circle-artifacts.com" > circle.yml && \
            jekyll build -d html -b "/0/html"  --config _config.yml,circle.yml && \
            find ./html/ -type f -iname '*html' | xargs -I{} sed -i \
              -e 's|href="\(\.\/.*\/\)"|href="\1index.html"|g' \
              -e '/0\/html/ s|href="\(\/.*\/\)"|href="\1index.html"|g' {}
            # Replace pages ending on `/` from our site to direct to index.html

      - run:
          name: "Built documentation is available at:"
          command: DOCS_URL="${CIRCLE_BUILD_URL}/artifacts/${CIRCLE_NODE_INDEX}/html/index.html"; echo $DOCS_URL

      # collect reports
      - store_artifacts:
          path: ~/repo/html
          destination: html

notify:
  webhooks:
    - url: https://giles.cadair.dev/circleci
